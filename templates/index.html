<html>
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/css/materialize.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/js/materialize.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.js"></script>

<div class="container">
<header>
<h4>climon</h4>
<div class="row">
<div class="col s12">
<ul class="tabs">
	<li class="tab col s3"><a href="#day">Day</a></li>
	<li class="tab col s3"><a href="#week">Week</a></li>
	<li class="tab col s3"><a href="#month">Month</a></li>
	<li class="tab col s3"><a href="#all">All</a></li>
</ul>
</div>
</div>
</header>
<div id="day" class="col s12">
</div>
<div id="week" class="col s12">
</div>
<div id="month" class="col s12">
</div>
<div id="all" class="col s12">
</div>
<main>
<div class="card-panel">
<div style="height: 200px;">
<canvas id="tempChart" style="height: 200px"></canvas>
</div>
</div>
<div class="card-panel">
<div style="height: 200px;">
<canvas id="humChart" style="height: 200px"></canvas>
</div>
</div>
<script>
function convertHex(hex, opacity){
    hex = hex.replace('#','');
    r = parseInt(hex.substring(0,2), 16);
    g = parseInt(hex.substring(2,4), 16);
    b = parseInt(hex.substring(4,6), 16);

    result = 'rgba('+r+','+g+','+b+','+opacity/100+')';
    return result;
}

sensors = {
{% for sensor_id, sensor_conf in sensor_confs.items() %}
'{{ sensor_id }}': {
        color: '{{ sensor_conf['color'] }}',
        bgColor: convertHex('{{ sensor_conf['color'] }}', 50),
        name: '{{ sensor_conf['name'] }}',
        },
{% endfor %}
};
humData=[];
tempData=[];
for (var key in sensors)
{
    tempData.push(
        {
            label: sensors[key]['name'] + '_min',
            pointRadius: 0,
            borderWidth: 1,
            data: [],
            backgroundColor: sensors[key]['bgColor'],
            borderColor: sensors[key]['bgColor'],
            key: key + '_min',
            fill: '+2',
        }
    );
    tempData.push(
        {
            label: sensors[key]['name'],
            pointRadius: 0,
            borderWidth: 2,
            data: [],
            backgroundColor: "rgba(0, 0, 0, 0)",
            borderColor: sensors[key]['color'],
            key: key,
            fill: false,
        }
    );
    tempData.push(
        {
            label: sensors[key]['name'] + '_max',
            pointRadius: 0,
            borderWidth: 1,
            data: [],
            backgroundColor: sensors[key]['bgColor'],
            borderColor: sensors[key]['bgColor'],
            key: key + '_max',
            fill: false,
        }
    );
    humData.push(
        {
            label: sensors[key]['name'] + '_min',
            pointRadius: 0,
            borderWidth: 1,
            data: [],
            backgroundColor: sensors[key]['bgColor'],
            borderColor: sensors[key]['bgColor'],
            key: key + '_min',
            fill: '+2',
        }
    );
    humData.push(
        {
            label: sensors[key]['name'],
            pointRadius: 0,
            borderWidth: 2,
            data: [],
            backgroundColor: "rgba(0,0,0,0)",
            borderColor: sensors[key]['color'],
            key: key,
        }
    );
    humData.push(
        {
            label: sensors[key]['name'] + '_max',
            pointRadius: 0,
            borderWidth: 1,
            data: [],
            backgroundColor: sensors[key]['bgColor'],
            borderColor: sensors[key]['bgColor'],
            key: key + '_max',
            fill: false,
        }
    );
}
var ctx = $("#tempChart");
window.myTempChart = new Chart(ctx, {
    type: 'line',
    data: {
        datasets: tempData
    },
    options: {
        legend: {
            display: false
        },
        scales: {
            xAxes: [{
                type: 'time',
                position: 'bottom',
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Temperature Â°C'
              }
            }]
        },
        responsive: true,
        maintainAspectRatio: false,
        animation: false
    }
});
var ctx = $("#humChart");
window.myHumChart = new Chart(ctx, {
    type: 'line',
    data: {
        datasets: humData
    },
    options: {
        legend: {
            display: false
        },
        scales: {
            xAxes: [{
                type: 'time',
                position: 'bottom'
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Humidity %'
              }
            }]
        },
        responsive: true,
        maintainAspectRatio: false,
        animation: false
    }
});
function showGraph(range) {
	$.getJSON( "/data/" + range + "/{{date}}", function( resp ) {
        alert('update');
        location.hash = '#' + range;
        window.myTempChart.data.datasets.forEach((dataset) => {
            dataset.data = [];
        });
        window.myHumChart.data.datasets.forEach((dataset) => {
            dataset.data = [];
        });

        window.myHumChart.data.labels = resp['labels'];
        window.myTempChart.data.labels = resp['labels'];

		for (var key in resp['data'])
		{
		    window.myTempChart.data.datasets.forEach((dataset) => {
		        if (dataset.key == key) {
		    	    dataset.data = resp['data'][key]['temperatures'];
		        }
		        if (dataset.key == key + '_min') {
		    	    dataset.data = resp['data'][key]['temperatures_min'];
		        }
		        if (dataset.key == key + '_max') {
		    	    dataset.data = resp['data'][key]['temperatures_max'];
		        }
		    });
		    window.myHumChart.data.datasets.forEach((dataset) => {
		        if (dataset.key == key) {
		    	    dataset.data = resp['data'][key]['humidities'];
		        }
		        if (dataset.key == key + '_min') {
		    	    dataset.data = resp['data'][key]['humidities_min'];
		        }
		        if (dataset.key == key + '_max') {
		    	    dataset.data = resp['data'][key]['humidities_max'];
		        }
		    });
		}
		window.myTempChart.update();
		window.myHumChart.update();

        setTimeout(function(){showGraph(range)}, 60000);
	});
}
if (window.location.hash) {
    showGraph(window.location.hash.substring(1));
} else {
    showGraph('day');
}
</script>
<script>
$(document).ready(function() { 
$("ul.tabs").tabs({ onShow: function(tab) {
	showGraph(tab.attr('id'));
} });
})
</script>
</main>
</div>
</body>
</html>
